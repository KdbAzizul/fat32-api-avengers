# version: '3.8'

# networks:
#   careforall-net:
#     driver: bridge

# volumes:
#   # Persistent Data for Databases
#   user_db_data:
#   campaign_db_data:
#   donation_db_data:
#   payment_db_data:
#   banking_db_data:
#   notification_db_data:
#   # Infrastructure Data
#   kafka_data:
#   zookeeper_data:
#   grafana_data:
#   loki_data:

# services:
#   # ==========================================
#   # 1. INFRASTRUCTURE & MESSAGING
#   # ==========================================
  
#   zookeeper:
#     image: confluentinc/cp-zookeeper:${ZOOKEEPER_VERSION:-7.4.0}
#     container_name: careforall-zookeeper
#     environment:
#       ZOOKEEPER_CLIENT_PORT: 2181
#       ZOOKEEPER_TICK_TIME: 2000
#     networks:
#       - careforall-net

#   kafka:
#     image: confluentinc/cp-kafka:${KAFKA_VERSION:-7.4.0}
#     container_name: careforall-kafka
#     depends_on:
#       - zookeeper
#     ports:
#       - "9092:9092"
#     environment:
#       KAFKA_BROKER_ID: 1
#       KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
#       KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
#       KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
#       KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
#       KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
#       KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
#     networks:
#       - careforall-net
#     healthcheck:
#       test: nc -z localhost 9092 || exit 1
#       interval: 10s
#       timeout: 10s
#       retries: 5

#   kafka-ui:
#     image: provectuslabs/kafka-ui:${KAFKA_UI_VERSION:-latest}
#     container_name: careforall-kafka-ui
#     ports:
#       - "${PORT_KAFKA_UI:-8080}:8080"
#     environment:
#       KAFKA_CLUSTERS_0_NAME: local
#       KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
#     networks:
#       - careforall-net

#   redis:
#     image: redis:${REDIS_VERSION:-7-alpine}
#     container_name: careforall-redis
#     ports:
#       - "${PORT_REDIS:-6379}:6379"
#     networks:
#       - careforall-net

#   # ==========================================
#   # 2. OBSERVABILITY STACK
#   # ==========================================

#   jaeger:
#     image: jaegertracing/all-in-one:${JAEGER_VERSION:-latest}
#     container_name: careforall-jaeger
#     ports:
#       - "${PORT_JAEGER_UI:-16686}:16686" # UI
#       - "${PORT_JAEGER_GRPC:-4317}:4317" # OTLP gRPC
#     networks:
#       - careforall-net

#   loki:
#     image: grafana/loki:${LOKI_VERSION:-2.9.0}
#     container_name: careforall-loki
#     ports:
#       - "${PORT_LOKI:-3100}:3100"
#     command: -config.file=/etc/loki/local-config.yaml
#     networks:
#       - careforall-net

#   grafana:
#     image: grafana/grafana:${GRAFANA_VERSION:-latest}
#     container_name: careforall-grafana
#     ports:
#       - "${PORT_GRAFANA:-3000}:3000"
#     environment:
#       - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
#     volumes:
#       - grafana_data:/var/lib/grafana
#     networks:
#       - careforall-net

#   # ==========================================
#   # 3. DEDICATED DATABASES
#   # ==========================================

#   user-db:
#     image: postgres:${POSTGRES_VERSION:-15-alpine}
#     container_name: user-db
#     env_file: ./user-service/.env # Loads POSTGRES_USER/PASS/DB
#     ports:
#       - "${PORT_DB_USER:-5433}:5432"
#     volumes:
#       - user_db_data:/var/lib/postgresql/data
#     networks:
#       - careforall-net
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   campaign-db:
#     image: postgres:${POSTGRES_VERSION:-15-alpine}
#     container_name: campaign-db
#     env_file: ./campaign-service/.env
#     ports:
#       - "${PORT_DB_CAMPAIGN:-5434}:5432"
#     volumes:
#       - campaign_db_data:/var/lib/postgresql/data
#     networks:
#       - careforall-net
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   donation-db:
#     image: postgres:${POSTGRES_VERSION:-15-alpine}
#     container_name: donation-db
#     env_file: ./donation-service/.env
#     ports:
#       - "${PORT_DB_DONATION:-5437}:5432"
#     volumes:
#       - donation_db_data:/var/lib/postgresql/data
#     networks:
#       - careforall-net
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   payment-db:
#     image: postgres:${POSTGRES_VERSION:-15-alpine}
#     container_name: payment-db
#     env_file: ./payment-service/.env
#     ports:
#       - "${PORT_DB_PAYMENT:-5436}:5432"
#     volumes:
#       - payment_db_data:/var/lib/postgresql/data
#     networks:
#       - careforall-net
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   banking-db:
#     image: postgres:${POSTGRES_VERSION:-15-alpine}
#     container_name: banking-db
#     env_file: ./banking-service/.env
#     ports:
#       - "${PORT_DB_BANKING:-5438}:5432"
#     volumes:
#       - banking_db_data:/var/lib/postgresql/data
#     networks:
#       - careforall-net
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   notification-db:
#     image: postgres:${POSTGRES_VERSION:-15-alpine}
#     container_name: notification-db
#     env_file: ./notification-service/.env
#     ports:
#       - "${PORT_DB_NOTIFICATION:-5435}:5432"
#     volumes:
#       - notification_db_data:/var/lib/postgresql/data
#     networks:
#       - careforall-net
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
#       interval: 5s
#       timeout: 5s
#       retries: 5

#   # ==========================================
#   # 4. MICROSERVICES
#   # ==========================================

#   user-service:
#     build: ./user-service
#     container_name: user-service
#     env_file: ./user-service/.env
#     ports:
#       - "${PORT_USER_SERVICE:-8001}:8001"
#     # Assuming standard entry point, adjust if 'app' folder nesting requires 'app.main:app'
#     # command: uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
#     depends_on:
#       user-db:
#         condition: service_healthy
#     networks:
#       - careforall-net

#   campaign-service:
#     build: ./campaign-service
#     container_name: campaign-service
#     env_file: ./campaign-service/.env
#     ports:
#       - "${PORT_CAMPAIGN_SERVICE:-8002}:8002"
#       - "50051:50051" # gRPC
#     # Runs both HTTP (Uvicorn) and gRPC server
#     # command: sh -c "python app/grpc/server.py & uvicorn app.main:app --host 0.0.0.0 --port 8002 --reload"
#     depends_on:
#       campaign-db:
#         condition: service_healthy
#       redis:
#         condition: service_started
#     networks:
#       - careforall-net

#   donation-service:
#     build: ./donation-service
#     container_name: donation-service
#     env_file: ./donation-service/.env
#     ports:
#       - "${PORT_DONATION_SERVICE:-8004}:8004"
#     # command: uvicorn app.main:app --host 0.0.0.0 --port 8004 --reload
#     depends_on:
#       donation-db:
#         condition: service_healthy
#       kafka:
#         condition: service_healthy
#     networks:
#       - careforall-net

#   payment-service:
#     build: ./payment-service
#     container_name: payment-service
#     env_file: ./payment-service/.env
#     ports:
#       - "${PORT_PAYMENT_SERVICE:-8003}:8003"
#     # command: uvicorn app.main:app --host 0.0.0.0 --port 8003 --reload
#     depends_on:
#       payment-db:
#         condition: service_healthy
#       kafka:
#         condition: service_healthy
#     networks:
#       - careforall-net

#   banking-service:
#     build: ./banking-service
#     container_name: banking-service
#     env_file: ./banking-service/.env
#     ports:
#       - "${PORT_BANKING_SERVICE:-8006}:8006"
#     # command: uvicorn app.main:app --host 0.0.0.0 --port 8006 --reload
#     depends_on:
#       banking-db:
#         condition: service_healthy
#     networks:
#       - careforall-net

#   notification-service:
#     build: ./notification-service
#     container_name: notification-service
#     env_file: ./notification-service/.env
#     ports:
#       - "${PORT_NOTIFICATION_SERVICE:-8005}:8005"
#     # command: uvicorn app.main:app --host 0.0.0.0 --port 8005 --reload
#     depends_on:
#       notification-db:
#         condition: service_healthy
#       kafka:
#         condition: service_healthy
#     networks:
#       - careforall-net

#   api-gateway:
#     build: ./api-gateway
#     container_name: api-gateway
#     env_file: ./api-gateway/.env
#     ports:
#       - "${PORT_API_GATEWAY:-8000}:8000"
#     # command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
#     depends_on:
#       - redis
#       - jaeger
#       - user-service
#       - campaign-service
#     networks:
#       - careforall-net

#   # ==========================================
#   # 5. FRONTEND
#   # ==========================================
  
#   # frontend:
#   #   build: ./frontend
#   #   container_name: careforall-frontend
#   #   ports:
#   #     - "3000:3000"
#   #   # Connects to API Gateway from the browser (localhost) or Server Side (api-gateway:8000)
#   #   environment:
#   #     - NEXT_PUBLIC_API_URL=http://localhost:8000
#   #   depends_on:
#   #     - api-gateway
#   #   networks:
#   #     - careforall-net

#   # ==========================================
#   # 6. LOAD TESTING TOOLS
#   # ==========================================

#   locust:
#     image: locustio/locust
#     container_name: careforall-locust
#     ports:
#       - "8089:8089"
#     volumes:
#       - ./locust:/mnt/locust
#     command: -f /mnt/locust/locustfile.py
#     networks:
#       - careforall-net
#   frontend:
#     build:
#       context: ./frontend
#       args:
#         # This bakes the URL into the React code during the Docker build
#         - NEXT_PUBLIC_API_URL=http://localhost:8000
#     container_name: careforall-frontend
#     ports:
#       - "3000:3000"
#     environment:
#       # This is still needed for Server Components (SSR)
#       - NEXT_PUBLIC_API_URL=http://api-gateway:8000 
#     depends_on:
#       - api-gateway
#     networks:
#       - careforall-net    



version: '3.8'

networks:
  careforall-net:
    driver: bridge

volumes:
  # Database Data
  user_db_data:
  campaign_db_data:
  donation_db_data:
  payment_db_data:
  banking_db_data:
  notification_db_data:
  # Infra Data
  kafka_data:
  zookeeper_data:
  grafana_data:
  loki_data:

services:
  # ==========================================
  # 1. INFRASTRUCTURE & MESSAGING
  # ==========================================
  
  zookeeper:
    image: confluentinc/cp-zookeeper:${ZOOKEEPER_VERSION:-7.4.0}
    container_name: careforall-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - careforall-net

  kafka:
    image: confluentinc/cp-kafka:${KAFKA_VERSION:-7.4.0}
    container_name: careforall-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - careforall-net
    healthcheck:
      test: nc -z localhost 9092 || exit 1
      interval: 10s
      timeout: 10s
      retries: 5

  kafka-ui:
    image: provectuslabs/kafka-ui:${KAFKA_UI_VERSION:-latest}
    container_name: careforall-kafka-ui
    ports:
      - "${PORT_KAFKA_UI:-8080}:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
    networks:
      - careforall-net

  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: careforall-redis
    ports:
      - "${PORT_REDIS:-6379}:6379"
    networks:
      - careforall-net

  # ==========================================
  # 2. OBSERVABILITY STACK
  # ==========================================

  jaeger:
    image: jaegertracing/all-in-one:${JAEGER_VERSION:-latest}
    container_name: careforall-jaeger
    ports:
      - "${PORT_JAEGER_UI:-16686}:16686"
      - "${PORT_JAEGER_GRPC:-4317}:4317"
    networks:
      - careforall-net

  loki:
    image: grafana/loki:${LOKI_VERSION:-2.9.0}
    container_name: careforall-loki
    ports:
      - "${PORT_LOKI:-3100}:3100"
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - careforall-net

  grafana:
    image: grafana/grafana:${GRAFANA_VERSION:-latest}
    container_name: careforall-grafana
    ports:
      - "${PORT_GRAFANA:-3001}:3000" # Mapped to 3001
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - careforall-net

  # ==========================================
  # 3. DEDICATED DATABASES
  # ==========================================
  # Note: healthchecks use $$POSTGRES_USER to read from container env

  user-db:
    image: postgres:${POSTGRES_VERSION:-15-alpine}
    container_name: user-db
    env_file: ./user-service/.env
    ports:
      - "${PORT_DB_USER:-5433}:5432"
    volumes:
      - user_db_data:/var/lib/postgresql/data
    networks:
      - careforall-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  campaign-db:
    image: postgres:${POSTGRES_VERSION:-15-alpine}
    container_name: campaign-db
    env_file: ./campaign-service/.env
    ports:
      - "${PORT_DB_CAMPAIGN:-5434}:5432"
    volumes:
      - campaign_db_data:/var/lib/postgresql/data
    networks:
      - careforall-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  donation-db:
    image: postgres:${POSTGRES_VERSION:-15-alpine}
    container_name: donation-db
    env_file: ./donation-service/.env
    ports:
      - "${PORT_DB_DONATION:-5437}:5432"
    volumes:
      - donation_db_data:/var/lib/postgresql/data
    networks:
      - careforall-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  payment-db:
    image: postgres:${POSTGRES_VERSION:-15-alpine}
    container_name: payment-db
    env_file: ./payment-service/.env
    ports:
      - "${PORT_DB_PAYMENT:-5436}:5432"
    volumes:
      - payment_db_data:/var/lib/postgresql/data
    networks:
      - careforall-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  banking-db:
    image: postgres:${POSTGRES_VERSION:-15-alpine}
    container_name: banking-db
    env_file: ./banking-service/.env
    ports:
      - "${PORT_DB_BANKING:-5438}:5432"
    volumes:
      - banking_db_data:/var/lib/postgresql/data
    networks:
      - careforall-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  notification-db:
    image: postgres:${POSTGRES_VERSION:-15-alpine}
    container_name: notification-db
    env_file: ./notification-service/.env
    ports:
      - "${PORT_DB_NOTIFICATION:-5435}:5432"
    volumes:
      - notification_db_data:/var/lib/postgresql/data
    networks:
      - careforall-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ==========================================
  # 4. MICROSERVICES
  # ==========================================

  # SERVICE 1: USER (Root main.py)
  user-service:
    build: ./user-service
    container_name: user-service
    env_file: ./user-service/.env
    environment:
      - PYTHONPATH=/app
    ports:
      - "${PORT_USER_SERVICE:-8001}:8001"
    command: uvicorn main:app --host 0.0.0.0 --port 8001 --reload
    depends_on:
      user-db:
        condition: service_healthy
    networks:
      - careforall-net

  # SERVICE 2: CAMPAIGN (Nested app/main.py)
  campaign-service:
    build: ./campaign-service
    container_name: campaign-service
    env_file: ./campaign-service/.env
    environment:
      - PYTHONPATH=/app
    ports:
      - "${PORT_CAMPAIGN_SERVICE:-8002}:8002"
      - "50051:50051"
    # Runs gRPC server + FastAPI
    command: sh -c "python app/grpc/server.py & uvicorn app.main:app --host 0.0.0.0 --port 8002 --reload"
    depends_on:
      campaign-db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - careforall-net

  # SERVICE 3: DONATION (Nested app/main.py)
  donation-service:
    build: ./donation-service
    container_name: donation-service
    env_file: ./donation-service/.env
    environment:
      - PYTHONPATH=/app
    ports:
      - "${PORT_DONATION_SERVICE:-8004}:8004"
    command: uvicorn app.main:app --host 0.0.0.0 --port 8004 --reload
    depends_on:
      donation-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - careforall-net

  # SERVICE 4: PAYMENT (Root main.py)
  payment-service:
    build: ./payment-service
    container_name: payment-service
    env_file: ./payment-service/.env
    environment:
      - PYTHONPATH=/app
    ports:
      - "${PORT_PAYMENT_SERVICE:-8003}:8003"
    command: uvicorn main:app --host 0.0.0.0 --port 8003 --reload
    depends_on:
      payment-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - careforall-net

  # SERVICE 5: BANKING (Root main.py)
  banking-service:
    build: ./banking-service
    container_name: banking-service
    env_file: ./banking-service/.env
    environment:
      - PYTHONPATH=/app
    ports:
      - "${PORT_BANKING_SERVICE:-8006}:8006"
    command: uvicorn main:app --host 0.0.0.0 --port 8006 --reload
    depends_on:
      banking-db:
        condition: service_healthy
    networks:
      - careforall-net

  # SERVICE 6: NOTIFICATION (Root main.py)
  notification-service:
    build: ./notification-service
    container_name: notification-service
    env_file: ./notification-service/.env
    environment:
      - PYTHONPATH=/app
    ports:
      - "${PORT_NOTIFICATION_SERVICE:-8005}:8005"
    command: uvicorn main:app --host 0.0.0.0 --port 8005 --reload
    depends_on:
      notification-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - careforall-net

  # SERVICE 7: API GATEWAY (Root main.py)
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    env_file: ./api-gateway/.env
    environment:
      - PYTHONPATH=/app
    ports:
      - "${PORT_API_GATEWAY:-8000}:8000"
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      - redis
      - jaeger
      - user-service
      - campaign-service
    networks:
      - careforall-net

  # ==========================================
  # 5. FRONTEND
  # ==========================================
  
  frontend:
    build:
      context: ./frontend
      # Next.js 13+ requires build arguments for public variables
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:8000
    container_name: careforall-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://api-gateway:8000
    depends_on:
      - api-gateway
    networks:
      - careforall-net

  # ==========================================
  # 6. LOAD TESTING TOOLS
  # ==========================================

  locust:
    image: locustio/locust
    container_name: careforall-locust
    ports:
      - "8089:8089"
    volumes:
      - ./locust:/mnt/locust
    command: -f /mnt/locust/locustfile.py
    networks:
      - careforall-net