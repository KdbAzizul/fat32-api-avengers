# --- DB INIT SCRIPT ---
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-init-script
data:
  init.sql: |
    CREATE DATABASE user_db;
    CREATE DATABASE campaign_db;
    CREATE DATABASE donation_db;
    CREATE DATABASE payment_db;
    CREATE DATABASE notification_db;
    CREATE DATABASE banking_db;
---
# --- SHARED POSTGRES ---
apiVersion: apps/v1
kind: Deployment
metadata: { name: postgres }
spec:
  replicas: 1
  selector: { matchLabels: { app: postgres } }
  template:
    metadata: { labels: { app: postgres } }
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          resources: { requests: { memory: "128Mi" }, limits: { memory: "256Mi" } }
          env:
            - { name: POSTGRES_USER, value: "admin" }
            - { name: POSTGRES_PASSWORD, value: "admin" }
          ports: [{ containerPort: 5432 }]
          volumeMounts:
            - { name: db-init, mountPath: /docker-entrypoint-initdb.d }
      volumes:
        - { name: db-init, configMap: { name: db-init-script } }
---
# --- SERVICES FOR DB ---
apiVersion: v1
kind: Service
metadata: { name: user-db }
spec: { ports: [{ port: 5432 }], selector: { app: postgres } }
---
apiVersion: v1
kind: Service
metadata: { name: campaign-db }
spec: { ports: [{ port: 5432 }], selector: { app: postgres } }
---
apiVersion: v1
kind: Service
metadata: { name: donation-db }
spec: { ports: [{ port: 5432 }], selector: { app: postgres } }
---
apiVersion: v1
kind: Service
metadata: { name: payment-db }
spec: { ports: [{ port: 5432 }], selector: { app: postgres } }
---
apiVersion: v1
kind: Service
metadata: { name: notification-db }
spec: { ports: [{ port: 5432 }], selector: { app: postgres } }
---
apiVersion: v1
kind: Service
metadata: { name: banking-db }
spec: { ports: [{ port: 5432 }], selector: { app: postgres } }

# --- REDIS ---
---
apiVersion: apps/v1
kind: Deployment
metadata: { name: redis }
spec:
  replicas: 1
  selector: { matchLabels: { app: redis } }
  template:
    metadata: { labels: { app: redis } }
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          ports: [{ containerPort: 6379 }]
          resources: { limits: { memory: "128Mi" } }
---
apiVersion: v1
kind: Service
metadata: { name: redis }
spec: { ports: [{ port: 6379 }], selector: { app: redis } }

# --- KAFKA & ZOOKEEPER ---
---
apiVersion: apps/v1
kind: Deployment
metadata: { name: zookeeper }
spec:
  selector: { matchLabels: { app: zookeeper } }
  template:
    metadata: { labels: { app: zookeeper } }
    spec:
      containers:
        - name: zookeeper
          image: confluentinc/cp-zookeeper:7.0.1
          env:
            - { name: ZOOKEEPER_CLIENT_PORT, value: "2181" }
            - { name: ZOOKEEPER_TICK_TIME, value: "2000" }
          ports: [{ containerPort: 2181 }]
          resources: { limits: { memory: "256Mi" } }
---
apiVersion: v1
kind: Service
metadata: { name: zookeeper }
spec: { ports: [{ port: 2181 }], selector: { app: zookeeper } }
---
apiVersion: apps/v1
kind: Deployment
metadata: { name: kafka }
spec:
  selector: { matchLabels: { app: kafka } }
  template:
    metadata: { labels: { app: kafka } }
    spec:
      containers:
        - name: kafka
          image: confluentinc/cp-kafka:7.0.1
          ports: [{ containerPort: 9092 }, { containerPort: 29092 }]
          resources: { limits: { memory: "512Mi" } }
          env:
            - { name: KAFKA_BROKER_ID, value: "1" }
            - { name: KAFKA_ZOOKEEPER_CONNECT, value: "zookeeper:2181" }
            - { name: KAFKA_ADVERTISED_LISTENERS, value: "PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092" }
            - { name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP, value: "PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT" }
            - { name: KAFKA_INTER_BROKER_LISTENER_NAME, value: "PLAINTEXT" }
            - { name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR, value: "1" }
---
apiVersion: v1
kind: Service
metadata: { name: kafka }
spec: { ports: [{ port: 29092 }], selector: { app: kafka } }

# --- JAEGER ---
---
apiVersion: apps/v1
kind: Deployment
metadata: { name: jaeger }
spec:
  selector: { matchLabels: { app: jaeger } }
  template:
    metadata: { labels: { app: jaeger } }
    spec:
      containers:
        - name: jaeger
          image: jaegertracing/all-in-one:latest
          ports: [{ containerPort: 16686 }, { containerPort: 14268 }]
          resources: { limits: { memory: "128Mi" } }
---
apiVersion: v1
kind: Service
metadata: { name: jaeger }
spec: { ports: [{ port: 16686 }, { port: 14268 }], selector: { app: jaeger } }